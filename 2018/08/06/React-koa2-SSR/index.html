
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>buctwbzs - buctwbzs blog</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="buctwbzs,"> 
    <meta name="description" content="buctwbzs&#39;s blog,ç³»ç»Ÿç¼–ç¨‹-Socketç½‘ç»œç¼–ç¨‹"> 
    <meta name="author" content="buctwbzs"> 
    <link rel="alternative" href="atom.xml" title="buctwbzs" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.ico"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8691406134231910",
        enable_page_level_ads: true
      });
    </script>

</head>
</html>
<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="æ’­æ”¾/æš‚åœ" class="icon-play"></div>
    <h3 class="subtitle">React-koa2-SSR</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="è·å–äºŒç»´ç " class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">React-koa2-SSR</h1>
        <div class="stuff">
            <span>å…«æœˆ 06, 2018</span>
            
  <ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/React/">React</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/SSR/">SSR</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/koa2/">koa2</a></li></ul>


        </div>
        <div class="content markdown">
            <p><img src="http://pd3105y8m.bkt.clouddn.com/yy8l1dr4hgtp.png" alt><br>æœ¬æ–‡é€šè¿‡æ„å»ºä¸€ä¸ªReact SSRé¡¹ç›®æ¥ä»‹ç»React16æœåŠ¡å™¨ç«¯æ¸²æŸ“ç›¸å…³æŠ€æœ¯ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>ç¯å¢ƒé…ç½®å’Œwebpack4+é…ç½®</li>
<li>å‰ç«¯é¡¹ç›®</li>
<li>SSR</li>
<li>SSRæ—¶å¦‚ä½•å¤„ç†React-routerã€Reduxã€styled-components</li>
<li>React16æ–°SSR API</li>
<li>devé˜¶æ®µèµ‹äºˆNode runtimeæ—¶å¤„ç†CSSå’Œimgçš„èƒ½åŠ›ï¼ŒSSRçƒ­æ›´æ–°</li>
</ul>
<p>Github <a href="https://github.com/buctwbzs/Personal-website" target="_blank" rel="noopener">repo</a></p>
<h3 id="åŸºç¡€å·¥ä½œ"><a href="#åŸºç¡€å·¥ä½œ" class="headerlink" title="åŸºç¡€å·¥ä½œ"></a>åŸºç¡€å·¥ä½œ</h3><h4 id="ç¯å¢ƒè®¾ç½®"><a href="#ç¯å¢ƒè®¾ç½®" class="headerlink" title="ç¯å¢ƒè®¾ç½®"></a>ç¯å¢ƒè®¾ç½®</h4><p><em>F</em>irst of allï¼Œæ£€æŸ¥ä¸€ä¸‹ç¥æœºæ˜¯å¦å·²ç»å®‰è£…äº†NodeJSå’Œnpmï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure></p>
<p>ç”±äºserveréƒ¨åˆ†ç”¨åˆ°es6è¯­æ³•ï¼Œåœ¨devæœªæ‰“åŒ…ğŸ“¦ä¹‹å‰éœ€è¦å¿…è¦çš„è¿è¡Œç¯å¢ƒï¼Œä¸‹è½½babel-nodeï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g babel-cli</span><br></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨nodemonå®ç°serverçƒ­æ›´æ–°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g nodemon</span><br></pre></td></tr></table></figure></p>
<h4 id="é¡¹ç›®åˆå§‹åŒ–"><a href="#é¡¹ç›®åˆå§‹åŒ–" class="headerlink" title="é¡¹ç›®åˆå§‹åŒ–"></a>é¡¹ç›®åˆå§‹åŒ–</h4><p>åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /your-path</span><br><span class="line">mkdir react-koa-ssr-demo</span><br><span class="line">cd react-koa-ssr-demo</span><br></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œ<code>npm init</code>ï¼Œé”®å…¥å¿…è¦ä¿¡æ¯ã€‚</p>
<p>åˆ›å»ºå¦‚ä¸‹æ–‡ä»¶ç»“æ„</p>
<p><img src="http://pd3105y8m.bkt.clouddn.com/WechatIMG125.jpeg" alt><br>æ–‡ä»¶ç»“æ„è¯´æ˜</p>
<ul>
<li>client front-endæºæ–‡ä»¶</li>
<li>server back-endæºæ–‡ä»¶</li>
<li>.babelrc babelé…ç½®æ–‡ä»¶</li>
<li>.browserslistrc ç›®æ ‡æµè§ˆå™¨é…ç½®</li>
<li>.postcss.config.js postcssé…ç½®æ–‡ä»¶</li>
<li>.eslintrc.js elinté…ç½®æ–‡ä»¶</li>
<li>webpack.common.js å‰ç«¯webpackå…¬ç”¨é…ç½®</li>
<li>webpack.dev.js å‰ç«¯webpackå¼€å‘é˜¶æ®µé…ç½®</li>
<li>webpack.prod.js å‰ç«¯webpackäº§å“é˜¶æ®µé…ç½®</li>
<li>webpack.server.js serverç«¯webpackäº§å“é˜¶æ®µé…ç½®</li>
</ul>
<p>å®‰è£…ä¾èµ–åŠç›¸åº”é…ç½®<a href="https://github.com/buctwbzs/Personal-website" target="_blank" rel="noopener">repo</a></p>
<ul>
<li><p>é¡¹ç›®ä¾èµ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -S react react-dom styled-components react-router redux react-redux koa koa-send koa-router</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D webpack webpack-cli webpack-dev-server</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack pligun </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D webpack-manifest-plugin webpack-merge html-webpack-plugin mini-css-extract-plugin uglifyjs-webpack-plugin optimize-css-assets-webpack-plugin clean-webpack-plugin</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack loader</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D url-loader  babel-loader file-loader node-sass sass-loader style-loader css-loader postcss-loader</span><br></pre></td></tr></table></figure>
</li>
<li><p>babel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D babel-core regenerator-runtime  babel-jest babel-plugin-import babel-plugin-transform-runtime babel-preset-env babel-preset-react babel-preset-stage-0</span><br></pre></td></tr></table></figure>
</li>
<li><p>eslint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D eslint babel-eslint eslint-plugin-react</span><br></pre></td></tr></table></figure>
</li>
<li><p>postcss</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D autoprefixer</span><br></pre></td></tr></table></figure>
</li>
<li><p>test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D jest babel-jest react-test-renderer</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>ä¸è¦æƒŠè®¶äºæœ‰è¿™ä¹ˆå¤šä¾èµ–ğŸ˜²ï¼Œéšç€demoçš„è¿›è¡Œæˆ‘ä»¬è¿˜éœ€è¦è‹¥å¹²å…¶ä»–çš„ä¾èµ–ğŸ˜ã€‚<br>å…³äº<code>babel</code>ã€<code>webpack</code>çš„é…ç½®ç­‰è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒç•´ã€‚é™äºç¯‡å¹…ï¼Œä¸ä¼šå¯¹é…ç½®è¿›è¡Œé€é¡¹è§£é‡Šï¼Œä¸è¿‡åœ¨æ¯ä¸ªæ—¶æœŸéƒ½ä¼šæŒ‡å‡ºæ­¤åˆ»åº”è¯¥å…·å¤‡äº†å“ªäº›é…ç½®æ–‡ä»¶åŠé…ç½®é¡¹ã€‚å¿…è¦æ—¶ï¼Œä¼šç»™å‡ºå…·ä½“é…ç½®ï¼Œå¹¶è§£é‡Šå¿…è¦é¡¹å’Œæ¶‰åŠSSRçš„é…ç½®ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥å»è¿™é‡Œå¯»æ‰¾ç­”æ¡ˆğŸ¤— <a href="https://github.com/buctwbzs/Personal-website" target="_blank" rel="noopener">repo</a>ã€‚</p>
<h3 id="å¼€å§‹å§ï¼-âŒ¨ï¸"><a href="#å¼€å§‹å§ï¼-âŒ¨ï¸" class="headerlink" title="å¼€å§‹å§ï¼ âŒ¨ï¸"></a>å¼€å§‹å§ï¼ âŒ¨ï¸</h3><h4 id="è¿ˆå‡ºç¬¬ä¸€æ­¥ï¼ğŸ•º"><a href="#è¿ˆå‡ºç¬¬ä¸€æ­¥ï¼ğŸ•º" class="headerlink" title="è¿ˆå‡ºç¬¬ä¸€æ­¥ï¼ğŸ•º"></a>è¿ˆå‡ºç¬¬ä¸€æ­¥ï¼ğŸ•º</h4><p>æ­¤åˆ»ä½ çš„demoé‡Œï¼Œåº”è¯¥è‡³å°‘åŒ…å«å¦‚ä¸‹é…ç½®æ–‡ä»¶</p>
<ul>
<li><p>.babelrc</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    <span class="string">"env"</span>,</span><br><span class="line">    <span class="string">"react"</span>,</span><br><span class="line">    <span class="string">"stage-0"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"plugins"</span>: [</span><br><span class="line">    <span class="string">"transform-runtime"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack.common.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">const</span> CleanWebpackPlugin = <span class="built_in">require</span>(<span class="string">'clean-webpack-plugin'</span>)</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>)</span><br><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    index: <span class="string">'./client/Index.jsx'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist/client'</span>),</span><br><span class="line">    filename: <span class="string">'[hash].[name].bundle.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(scss|css)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          MiniCssExtractPlugin.loader,</span><br><span class="line">          &#123; <span class="attr">loader</span>: <span class="string">'css-loader'</span>, <span class="attr">options</span>: &#123; <span class="attr">importLoaders</span>: <span class="number">2</span> &#125; &#125;,</span><br><span class="line">          <span class="string">'postcss-loader'</span>,</span><br><span class="line">          <span class="string">'sass-loader'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(png|svg|jpg|gif)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'file-loader'</span></span><br><span class="line">        ],</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(woff|woff2|eot|ttf|otf)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'file-loader'</span></span><br><span class="line">        ],</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(js|jsx)$/</span>,</span><br><span class="line">        use: &#123;</span><br><span class="line">          loader: <span class="string">'babel-loader'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">'async'</span>,</span><br><span class="line">      minSize: <span class="number">30000</span>,</span><br><span class="line">      minChunks: <span class="number">1</span>,</span><br><span class="line">      maxAsyncRequests: <span class="number">5</span>,</span><br><span class="line">      maxInitialRequests: <span class="number">3</span>,</span><br><span class="line">      name: <span class="literal">false</span>,</span><br><span class="line">      cacheGroups: &#123;</span><br><span class="line">        vendor: &#123;</span><br><span class="line">          chunks: <span class="string">'all'</span>,</span><br><span class="line">          test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          name: <span class="string">'vendor'</span>,</span><br><span class="line">          minChunks: <span class="number">1</span>,</span><br><span class="line">          maxInitialRequests: <span class="number">5</span>,</span><br><span class="line">          minSize: <span class="number">0</span>,</span><br><span class="line">          priority: <span class="number">100</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    extensions: [<span class="string">'.js'</span>, <span class="string">'.jsx'</span>, <span class="string">'.tsc'</span>, <span class="string">'scss'</span>, <span class="string">'css'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin([<span class="string">'dist'</span>]),</span><br><span class="line">    <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">      title: <span class="string">'buctwbzs'</span>,</span><br><span class="line">      template: <span class="string">'./client/template.html'</span>,</span><br><span class="line">      inject: <span class="string">'body'</span>,</span><br><span class="line">      chunks: [<span class="string">'index'</span>, <span class="string">'vendor'</span>]</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">      filename: <span class="string">'[id].[contenthash:12].css'</span>,</span><br><span class="line">      chunkFilename: <span class="string">'[id].[contenthash:12].css'</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack.dev.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="keyword">const</span> common = <span class="built_in">require</span>(<span class="string">'./webpack.common'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = merge(common, &#123;</span><br><span class="line">  devtool: <span class="string">'source-map'</span>,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    contentBase: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    port: <span class="string">'8080'</span>,</span><br><span class="line">    hot: <span class="literal">true</span>,</span><br><span class="line">    historyApiFallback: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</span><br><span class="line">      <span class="string">'process.env.NODE_ENV'</span>: <span class="built_in">JSON</span>.stringify(<span class="string">'development'</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> webpack.NamedModulesPlugin(),</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</span><br><span class="line">  ],</span><br><span class="line">  mode: <span class="string">'development'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>webpack.dev.jsæ„å»ºäºwebpack.common.jsä¹‹ä¸Šï¼Œå½“æˆ‘ä»¬æœ‰å¤šä¸ªé…ç½®æ–‡ä»¶æ—¶ï¼Œå°†é‡å¤éƒ¨åˆ†æŠ½ç¦»å‡ºæ¥æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚å‚çœ‹<a href="https://github.com/survivejs/webpack-merge" target="_blank" rel="noopener">webpack merge</a>çš„ç”¨æ³•ã€‚<br>ok,å…ˆæ¥æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„é…ç½®å§ï¼<br>åœ¨clientæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºindex.jsxã€App.jsx<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"></span><br><span class="line">render(&lt;App /&gt;, document.getElementById('app'))</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">       Welcome to react-koa-ssr turtorial!</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨package.json scriptsä¸‹æ·»åŠ <br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scripts: &#123;</span><br><span class="line">  "dev:client": "webpack-dev-server --hot --config webpack.dev.js",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œ<code>npm run dev:client</code>ï¼Œå¸Œæœ›ä½ è®¿é—®æœ¬åœ°8080ç«¯å£æ—¶å¯ä»¥å’Œæˆ‘ä¸€æ ·çœ‹åˆ°å¦‚ä¸‹ç»“æœ:</p>
<hr>
<p><img src="http://pd3105y8m.bkt.clouddn.com/image/WeChatWorkScreenshot_ad2a968a-0bc5-4936-8d46-58f545bc1d69.png" alt="first demo"></p>
<hr>
<h4 id="æœ€ç®€å•SSRğŸ¤—"><a href="#æœ€ç®€å•SSRğŸ¤—" class="headerlink" title="æœ€ç®€å•SSRğŸ¤—"></a>æœ€ç®€å•SSRğŸ¤—</h4><p>çœŸæ­£è¿›å…¥SSRä¹‹å‰ï¼Œè®©æˆ‘ä»¬å†åšä¸€ç‚¹é¢„å¤‡å·¥ä½œå§ï¼é¦–å…ˆæˆ‘ä»¬çš„å‰ç«¯é¡¹ç›®éœ€è¦buildå‡ºæ¥(è™½ç„¶ç›®å‰æ¥çœ‹å®ƒè¿˜éå¸¸çš„ç®€é™‹ğŸ˜­)ã€‚æ‰“å¼€webpack.prod.jsè¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">const</span> OptimizeCSSAssetsPlugin = <span class="built_in">require</span>(<span class="string">'optimize-css-assets-webpack-plugin'</span>)</span><br><span class="line"><span class="keyword">const</span> UglifyJsPlugin = <span class="built_in">require</span>(<span class="string">'uglifyjs-webpack-plugin'</span>)</span><br><span class="line"><span class="keyword">const</span> ManifestPlugin = <span class="built_in">require</span>(<span class="string">'webpack-manifest-plugin'</span>)</span><br><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">'webpack-merge'</span>)</span><br><span class="line"><span class="keyword">const</span> common = <span class="built_in">require</span>(<span class="string">'./webpack.common'</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = merge(common, &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> ManifestPlugin(&#123;</span><br><span class="line">      publicPath: <span class="string">'./'</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</span><br><span class="line">      <span class="string">'process.env.NODE_ENV'</span>: <span class="built_in">JSON</span>.stringify(<span class="string">'production'</span>),</span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    minimizer: [</span><br><span class="line">      <span class="keyword">new</span> UglifyJsPlugin(&#123;</span><br><span class="line">        cache: <span class="literal">true</span>,</span><br><span class="line">        parallel: <span class="literal">true</span>,</span><br><span class="line">        sourceMap: <span class="literal">true</span>,</span><br><span class="line">        uglifyOptions: &#123;</span><br><span class="line">          warnings: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="keyword">new</span> OptimizeCSSAssetsPlugin(&#123;&#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  performance: &#123;</span><br><span class="line">    hints: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  mode: <span class="string">'production'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>æ‹¥æœ‰webpack.common.jsä½¿å¾—æˆ‘ä»¬çš„webpack.prod.jsä¸­çš„å†…å®¹ç›¸å¯¹ç®€å•äº†è®¸å¤šï¼Œ<br>è™½ç„¶è¿™çœ‹èµ·æ¥å¹¶ä¸ç®—ç®€æ´ï¼ˆå†æ¬¡æç¤ºï¼Œä½ å¯ä»¥åœ¨<a href="https://github.com/buctwbzs/Personal-website" target="_blank" rel="noopener">è¿™é‡Œ</a>æ‰¾åˆ°å®Œæ•´çš„é…ç½®ï¼‰ã€‚<br>ç„¶ååœ¨æˆ‘ä»¬çš„package.jsonä¸‹çš„scriptsä¸‹å†æ·»åŠ ï¼š<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "build:client": "webpack --config webpack.prod.js"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ‰“å¼€shellï¼Œæ‰§è¡Œ<code>npm run build:client</code>ï¼Œæ²¡æœ‰æ„å¤–çš„è¯ï¼Œåœ¨æ ¹ç›®å½•ä¸‹åº”è¯¥å­˜åœ¨äº†ä¸€ä¸ªdistæ–‡ä»¶å¤¹ã€‚ç»“æ„å¦‚ä¸‹<br><img src="http://pd3105y8m.bkt.clouddn.com/image/WechatIMG127.jpeg" alt></p>
<p>åœ¨serverç›®å½•ä¸‹ä¸‹åˆ›å»ºmain.jsï¼Œå¼•å…¥Appç»„ä»¶å’ŒReactï¼Œå¹¶ä½¿ç”¨koaæ­å»ºæœ€ç®€å•çš„webæœåŠ¡ã€‚<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Koa <span class="keyword">from</span> <span class="string">'koa'</span></span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'koa-router'</span></span><br><span class="line"><span class="keyword">import</span> send <span class="keyword">from</span> <span class="string">'koa-send'</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; renderToString &#125; <span class="keyword">from</span> <span class="string">'react-dom/Server'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'../client/App'</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router()</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (ctx) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> SSRString = renderToString(&lt;App /&gt;)</span><br><span class="line">  const html = `$&#123;SSRString&#125;`</span><br><span class="line">  ctx.body = html</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br><span class="line">app.use(async ctx =&gt; &#123;</span><br><span class="line">  await send(ctx, ctx.path, &#123; root: '../dist/client' &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure></p>
<p><code>renderToString()</code>æ–¹æ³•å¯ä»¥å°†reactç»„ä»¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²,å½“serveræ¥å—åˆ°è¯·æ±‚æ—¶å°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br>è¿«ä¸åŠå¾…ï¼è®©æˆ‘ä»¬æ‰§è¡Œï¼š<code>node server/main.js</code>å§ã€‚</p>
<p><strong>Congratulations</strong>ï¼ğŸ¤— æˆ‘ä»¬ç»ˆäºè·å¾—äº†ç¬¬ä¸€ä¸ªæŠ¥é”™ã€‚å› ä¸ºnodeç¯å¢ƒä¸‹å¹¶ä¸æ”¯æŒimportï¼Œ<br>æ‰€ä»¥éœ€è¦ä¸ºserverç«¯ä»£ç é…ç½®ä¸‹babelã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå¼•å…¥äº†reactç»„ä»¶<code>&lt;App /&gt;</code>, å³ä½¿æˆ‘ä»¬é‡‡ç”¨commonjsï¼Œä¹Ÿæ— æ³•å¤„ç†jsxçš„é—®é¢˜ã€‚Soâ€¦.æ˜¯æ—¶å€™æ‰“å¼€å°˜å°çš„webpack.server.jsäº†!</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">'mini-css-extract-plugin'</span>)</span><br><span class="line"><span class="keyword">const</span>  webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  target: <span class="string">'node'</span>,</span><br><span class="line">  entry: path.resolve(__dirname, <span class="string">'server/main.js'</span>),</span><br><span class="line">  output: &#123;</span><br><span class="line">    libraryTarget: <span class="string">'commonjs2'</span>,</span><br><span class="line">    path: path.resolve(__dirname,  <span class="string">'dist/server'</span>),</span><br><span class="line">    filename: <span class="string">'[name].js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(js|jsx)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'babel-loader'</span></span><br><span class="line">        ],</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    extensions: [<span class="string">'.jsx'</span>, <span class="string">'.js'</span>, <span class="string">'.json'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  mode: <span class="string">'production'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ğŸ””ï¼Œç”±äºæ‰“åŒ…åçš„ä»£ç æ˜¯è¿è¡Œåœ¨nodeç¯å¢ƒä¸Šçš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç‚¹ç‰¹æ®Šçš„é…ç½®ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">target: <span class="string">'node'</span>,</span><br><span class="line">output:&#123;</span><br><span class="line">  ...,</span><br><span class="line">  libraryTarget: <span class="string">'commonjs2'</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆåˆ°äº†æ·»åŠ scriptsçš„æ—¶é—´äº†<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "dev:client": "webpack-dev-server --hot --config webpack.dev.js",</span><br><span class="line">  "build:client": "webpack --config webpack.prod.js",</span><br><span class="line">  "build:server": "webpack --config webpack.server.js",</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œ</p>
<ul>
<li><code>npm run build:client</code> </li>
<li><code>npm run build:server</code></li>
<li><code>node dist/main.js</code></li>
</ul>
<p>å¦‚æœä¸€åˆ‡æ­£å¸¸çš„è¯ï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—® localhost:3000ï¼Œä½ åº”è¯¥å¾—åˆ°å¦‚ä¸‹çš„é¡µé¢ã€‚</p>
<hr>
<p><img src="http://pd3105y8m.bkt.clouddn.com/image/WeChatWorkScreenshot_ad2a968a-0bc5-4936-8d46-58f545bc1d69.png" alt="second"></p>
<hr>
<p>Ok,æˆ‘æ‰¿è®¤ï¼Œè¿™å’Œä¹‹å‰çš„å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«(<em>äº‹å®ä¸Šä¸ºäº†èŠ‚çº¦å›¾åºŠæµé‡å’Œå­˜å‚¨ç©ºé—´ï¼Œæˆ‘ä½¿ç”¨äº†ä¸Šé¢ä¾‹å­é‡Œçš„ä¸€å¼ å›¾ç‰‡</em>ğŸ˜)ã€‚<br>ä¸è¿‡è¿˜ä¸è¦å¤±æœ›ï¼æ‰§è¡Œå¦‚ä¸‹çš„æ“ä½œï¼š</p>
<ul>
<li>æ‰“å¼€æ§åˆ¶å°</li>
<li>é€‰æ‹©networkæ ‡ç­¾</li>
<li>åˆ·æ–°é¡µé¢</li>
<li>ç‚¹å¼€å”¯ä¸€çš„httpè¯·æ±‚</li>
<li>é€‰æ‹©responseï¼Œä½ çœ‹åˆ°åº”è¯¥å’Œä¸‹å›¾ä¸€æ ·</li>
</ul>
<hr>
<p> <img src="http://pd3105y8m.bkt.clouddn.com/WechatIMG128.jpeg" alt="ssr response"></p>
<hr>
<p>è¿™è¯´æ˜äº†ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬çš„ç®€é™‹çš„é¡µé¢ç¡®å®æ˜¯é€šè¿‡SSRæ¸²æŸ“å¾—æ¥çš„ã€‚<br>çœ‹åˆ°äº†å—ï¼Ÿæˆ‘ä»¬ç¡®å®å·²ç»å‘å‰è¿ˆè¿›äº†ä¸€å¤§æ­¥ï¼Œå®ƒçœŸçš„æ˜¯SSRï¼Œè™½ç„¶ä¾æ—§ç®€é™‹â˜ºï¸ï¼ç°åœ¨ï¼Œæ˜¯æ—¶å€™æ£€æŸ¥ä¸€ä¸‹é¡µé¢å…ƒç´ ï¼Œç„¶åæƒ³ä¸€ä¸‹æ˜¯ä¸æ˜¯è¿˜ç¼ºç‚¹ä»€ä¹ˆä¸œè¥¿äº†ã€‚</p>
<hr>
<p><img src="http://pd3105y8m.bkt.clouddn.com/image/WechatIMG129.jpeg" alt="ssr elements"></p>
<hr>
<p>é™¤äº†æµè§ˆå™¨ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„æœ€åŸºæœ¬çš„æ ‡ç­¾ï¼Œæˆ‘ä»¬ä¸€æ— æ‰€æœ‰ã€‚</p>
<p>æˆ‘ä»¬è¿˜ç¼ºä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ç¼ºå¿…è¦æ ‡ç­¾å’Œseoæ ‡ç­¾</li>
<li>ç•Œé¢å¤ªä¸‘äº†ï¼Œæˆ‘ä»¬è¦å†™ç‚¹æ ·å¼äº†ï¼Œè¿˜ç¼ºcssæ–‡ä»¶</li>
<li>ç½‘ç«™æ€»æ˜¯æœ‰ä¸€ä¸ªå¥½çœ‹çš„logo</li>
<li>å‰ç«¯buildå‡ºçš„æ–‡ä»¶è¿˜æ²¡æœ‰å¼•å…¥è¿›æ¥</li>
</ul>
<p>æ¥ä¸‹æ¥ä¸€æ­¥ä¸€æ­¥çš„æˆ‘ä»¬ä¸€èµ·å¤„ç†æ‰å®ƒä»¬</p>
<h4 id="å®Œæ•´çš„htmlğŸ¤¡"><a href="#å®Œæ•´çš„htmlğŸ¤¡" class="headerlink" title="å®Œæ•´çš„htmlğŸ¤¡"></a>å®Œæ•´çš„htmlğŸ¤¡</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç•¥å»å…¶ä»–å¼•å…¥import</span></span><br><span class="line"><span class="keyword">import</span> manifest <span class="keyword">from</span> <span class="string">'../dist/client/manifest.json'</span></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (ctx) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> SSRString = renderToString(&lt;App /&gt;)</span><br><span class="line">  const html = `</span><br><span class="line">    &lt;!DOCTYPE html&gt;</span><br><span class="line">    &lt;html lang="en"&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">      &lt;meta charset="UTF-8"&gt;</span><br><span class="line">      &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span><br><span class="line">      &lt;meta http-equiv="X-UA-Compatible" content="ie=edge"&gt;</span><br><span class="line">      &lt;title&gt;react-koa-sst&lt;/title&gt;</span><br><span class="line">      &lt;link href=$&#123;manifest['vendor.css']&#125; rel="stylesheet"&gt;</span><br><span class="line">      &lt;link href=$&#123;manifest['index.css']&#125; rel="stylesheet"&gt;</span><br><span class="line">      $&#123;styles&#125;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">      &lt;div id="app"&gt;$&#123;SSRString&#125;&lt;/div&gt;</span><br><span class="line">      &lt;script type="text/javascript" src=$&#123;manifest['vendor.js']&#125;&gt;&lt;/script&gt;</span><br><span class="line">      &lt;script type="text/javascript" src=$&#123;manifest['index.js']&#125;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">    &lt;/html&gt;</span><br><span class="line">  `</span><br><span class="line">  ctx.body = html</span><br><span class="line">&#125;)</span><br><span class="line">app.use(router.routes())</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†é¿å…é‡å¤è¾“å…¥ï¼Œæ”¹é€ ä¸€ä¸‹æˆ‘ä»¬çš„package.jsoné‡Œçš„scriptsï¼š<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "dev:client": "webpack-dev-server --hot --config webpack.dev.js",</span><br><span class="line">  "build:client": "webpack --config webpack.prod.js",</span><br><span class="line">  "build:server": "webpack --config webpack.server.js",</span><br><span class="line">  "build": "npm run build:client &amp;&amp; npm run build:server",</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>ä¹‹åbuildçš„è¯åªéœ€è¦æ‰§è¡Œ<code>npm run build</code>å°±å¯ä»¥äº†</p>
<p>è¿è¡Œ<code>npm run build</code>ï¼Œè™½ç„¶é¡µé¢ä¾ç„¶å¦‚æ—§ï¼Œä¸è¿‡ä½ åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ç»“æ„å®Œæ•´çš„htmläº†ã€‚æ­¤æ—¶æˆ‘ä»¬è¿˜æ²¡æœ‰å†™ä»»ä½•çš„æ ·å¼æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸è¦æ‹…å¿ƒ<code>link</code>æ ‡ç­¾çš„<code>href</code>ä¸º<code>undefind</code>ã€‚æ¥ä¸‹æ¥å°±æ·»åŠ ä¸€äº›æ ·å¼å§ï¼</p>
<h4 id="ç•Œé¢å¤ªä¸‘äº†-ğŸ˜¤"><a href="#ç•Œé¢å¤ªä¸‘äº†-ğŸ˜¤" class="headerlink" title="ç•Œé¢å¤ªä¸‘äº† ğŸ˜¤"></a>ç•Œé¢å¤ªä¸‘äº† ğŸ˜¤</h4><p>åœ¨clintä¸‹åˆ›å»ºapp.cssã€‚æ·»åŠ :<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: goldenrod;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å°†å…¶å¼•å…¥åˆ°App.jsxé‡Œï¼Œè¿è¡Œï¼š<code>npm run build</code>ã€‚</p>
<p>SurpriseğŸ¤—ï¼ç¬¬äºŒä¸ªæŠ¥é”™æ¥å–½ã€‚</p>
<hr>
<p><img src="http://pd3105y8m.bkt.clouddn.com/image/WeChatWorkScreenshot_8c16f5a6-852f-4072-b1a6-5052af727581.png" alt="css error"></p>
<hr>
<p>çœ‹ä¸‹æŠ¥é”™ä¿¡æ¯å¯çŸ¥ï¼Œå†è¿›è¡Œserverç«¯buildçš„æ—¶å€™å‡ºç°äº†é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºåœ¨webpack.server.jsé‡Œå¹¶æœªé…ç½®å¤„ç†cssçš„loaderã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œserverç«¯çš„css-loaderé…ç½®ä¸clientæœ‰æ‰€ä¸åŒï¼Œserverç«¯å¹¶ä¸éœ€è¦å‘ˆç°æ ·å¼ï¼Œåªéœ€è¦æå–å‡ºclassnameç­‰ä¿¡æ¯ã€‚åœ¨webpack.server.jsçš„rulesä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.(c|sc|sa)ss$/</span>,</span><br><span class="line">  use: [</span><br><span class="line">    <span class="string">'css-loader/locals?modules&amp;camelCase&amp;importLoaders=2&amp;localIdentName=[hash:base64:8]'</span>,</span><br><span class="line">    <span class="string">'postcss-loader'</span>,</span><br><span class="line">    <span class="string">'sass-loader'</span></span><br><span class="line">  ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯ä»¥å¯¹æ¯”å‡ºä¸clientç«¯çš„webpacké…ç½®çš„ä¸åŒä¹‹å¤„ã€‚å…·ä½“css-loderçš„ç”¨æ³•å¯ä»¥å‚è§<a href="https://webpack.js.org/loaders/css-loader/" target="_blank" rel="noopener">css-loader</a>ã€‚åŒæ—¶ï¼Œç”±äºæ‰“åŒ…åæ–‡ä»¶ä½ç½®çš„æ”¹å˜ï¼Œkoa-sendé™æ€æ–‡ä»¶ä¸­é—´ä»·çš„é…ç½®è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> send(ctx, ctx.path, &#123; <span class="attr">root</span>: <span class="string">'dist/client'</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨è¿è¡Œ<code>npm run build</code>-&gt;<code>node dist/server/main.js</code>ï¼Œè®¿é—®<code>loadhost:3000</code>ç«¯å£ä¼šå¾—åˆ°å¦‚ä¸‹é¡µé¢ï¼š</p>
<hr>
<p><img src="http://pd3105y8m.bkt.clouddn.com/image/WeChatWorkScreenshot_577106e6-a78d-4696-be98-1b99cfde78dc.png" alt="ssr with css"></p>
<hr>
<p>ç°åœ¨å¯ä»¥å¤„ç†cssäº†ï¼Œæˆ‘ä»¬å–å¾—äº†å°å°çš„è¿›æ­¥ã€‚å¦‚æœä½ è¶³å¤Ÿè®¤çœŸçš„è¯ï¼Œå¯ä»¥æ³¨æ„åˆ°ä¸Šé¢ä¹Ÿå·²ç»é…ç½®äº†sass-loaderå’Œpostcss-loaderï¼Œè¿™å¹¶æ²¡ä»€ä¹ˆéš¾çš„ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„å°±æ˜¯loadersçš„<strong>é¡ºåº</strong>ã€‚</p>
<p>è¿˜æ²¡æœ‰logoï¼ŸğŸ™„</p>
<p>ç°åœ¨æ¥æ·»åŠ ä¸€ä¸ªèƒ½å¤Ÿå¸å¼•è§‚ä¼—çš„logoå§ï¼è¿™æ¬¡ä½ åº”è¯¥èƒ½å¤Ÿæå‰æ„è¯†åˆ°ï¼Œwebpack.server.jsåº”è¯¥éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿå¤„ç†imageçš„loaderã€‚<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.(png|svg|jpg|gif)$/</span>,</span><br><span class="line">  use: [</span><br><span class="line">    <span class="string">'file-loader'</span></span><br><span class="line">  ],</span><br><span class="line">  exclude: <span class="regexp">/node_modules/</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>æ·»åŠ logoï¼Œåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºpublic/imageï¼Œæ·»åŠ ä¸€å¼ å›¾ç‰‡,å‘½åä¸ºlogo<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./app.css'</span></span><br><span class="line"><span class="keyword">import</span> logo <span class="keyword">from</span> <span class="string">'../public/image/logo.gif'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"box"</span>&gt;</span><br><span class="line">        &lt;img src=&#123;logo&#125; alt=<span class="string">"logo"</span> /&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">          Welcome to react-koa-ssr turtorial!</span><br><span class="line">        &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>é‡æ–°buildè¿è¡Œ<br>ç°åœ¨æˆ‘è¿™é‡Œçš„é¡µé¢å·²ç»è¶³å¤Ÿå¸å¼•äººäº†ï¼š<br><img src="http://pd3105y8m.bkt.clouddn.com/image/ssr.gif" alt="ssr with img"></p>
<h4 id="ä¸åœbuildç´¯skräºº-ğŸ˜"><a href="#ä¸åœbuildç´¯skräºº-ğŸ˜" class="headerlink" title="ä¸åœbuildç´¯skräºº ğŸ˜"></a>ä¸åœbuildç´¯skräºº ğŸ˜</h4><p>æˆ‘å‡è®¾ä½ å……æ»¡è€å¿ƒçš„çœ‹åˆ°äº†è¿™é‡Œï¼Œä¸çŸ¥é“ä½ åœ¨æ›´æ”¹åæ˜¯å¦ä¹Ÿç–²äºæ‰§è¡Œbuildï¼Œå’Œä½ ä¸€æ ·ï¼Œæˆ‘ä¹Ÿä¸èƒœå…¶æ‰°ã€‚å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œé‡å¤å°±æ˜¯ä¸‡æ¶ä¹‹æºã€‚ç°åœ¨éœ€è¦æ˜ç¡®çš„æ˜¯æˆ‘ä»¬éœ€è¦ä»€ä¹ˆï¼Ÿ<br> å¦‚æœserverç«¯çš„ä»£ç åœ¨æ¯æ¬¡æ›´æ–°ä»¥åä¸éœ€è¦æ‰‹åŠ¨buildçš„å°±å¥½äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨devé˜¶æ®µï¼Œæˆ‘ä»¬è¦æ”¾å¼ƒæ‰webpackæ‰“åŒ…ã€‚è¿™æ ·çš„è¯æ‘†åœ¨æˆ‘ä»¬é¢å‰çš„é—®é¢˜å°±æ˜¯ï¼šåœ¨devæ—¶æœŸèƒ½å¤Ÿè®©Node runtimeè·å¾—å¯è¿è¡Œçš„ä»£ç ã€‚</p>
<ul>
<li>å¤„ç†jsx</li>
<li>å¤„ç†css</li>
<li>å¤„ç†ä¸€äº›é™æ€èµ„æº</li>
</ul>
<p>å¯¹äºjsxè€Œè¨€ï¼Œæˆ‘ä»¬åªéœ€è¦babel-nodeã€‚å¯¹äº<code>scss</code>æˆ–è€…<code>css</code>æ¥è¯´ï¼Œå¦‚æœä¸ç»è¿‡loaderå¤„ç†ä¸ºjsï¼Œåœ¨nodeç¯å¢ƒä¸‹æ˜¯æ— æ³•è¢«è¯†åˆ«çš„ã€‚å¥½åœ¨ç°åœ¨æˆ‘ä»¬æœ‰äº†å…¶ä»–çš„æ–¹å¼ï¼š<a href="https://github.com/css-modules/css-modules-require-hook" target="_blank" rel="noopener">css-module-require-hook</a>å¯ä»¥åœ¨nodeè¿è¡Œæ—¶ç¼–è¯‘cssæ¨¡å—ã€‚<code>asset-require-hook</code>å¯ä»¥åœ¨nodeè¿è¡Œæ—¶å¤„ç†èµ„æºæ¨¡å—ã€‚æ¥ä¸‹æ¥å°†å…¶åŠ å…¥æˆ‘ä»¬çš„ä¾èµ–ä¸­<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D css-modules-require-hook asset-require-hook</span><br></pre></td></tr></table></figure></p>
<p>å†è¿›è¡Œé…ç½®ä¹‹å‰ï¼Œéœ€è¦æ˜ç¡®çš„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨prodçš„æƒ…å†µä¸éœ€è¦è¿™æ ·åšã€‚åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å·²ç»é€šè¿‡é…ç½®webpack.server.jså¤„ç†äº†è¿™äº›ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦çš„æ˜¯åœ¨ä¸è¿›è¡Œbuild serverç«¯ä»£ç çš„å‰æä¸‹æ¥å¤„ç†scssï¼Œimageç­‰ã€‚æ‰€ä»¥ï¼Œä¸ºäº†åŒºåˆ«devå’Œprodï¼Œç°åœ¨åœ¨serveræ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶<code>server.dev.js</code>,<code>server.prod.js</code>,ç„¶åå°†main.jsä¸­çš„åˆ†åˆ«ç§»è‡³ä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶ä¸­ï¼Œåˆ é™¤main.jsã€‚</p>
<p>åˆ›å»º<code>cmrh.conf.js</code>æ–‡ä»¶é…ç½®css-module-require-hookï¼Œå…³äº<a href="https://github.com/css-modules/css-modules-require-hook" target="_blank" rel="noopener">css-modules-require-hook</a>ä¸¤ç§æ–¹å¼çš„å…·ä½“ç”¨æ³•è¯·æŸ¥é˜…æ–‡æ¡£ã€‚<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  extensions: [<span class="string">'.scss'</span>],</span><br><span class="line">  preprocessCss: <span class="function">(<span class="params">data, filename</span>) =&gt;</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'node-sass'</span>).renderSync(&#123;</span><br><span class="line">      data,</span><br><span class="line">      file: filename</span><br><span class="line">    &#125;).css,</span><br><span class="line">  generateScopedName: <span class="string">'[name]_[local]__[hash:base64:5]'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ›´æ–°server.dev.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csshook <span class="keyword">from</span> <span class="string">'css-modules-require-hook/preset'</span> <span class="comment">// å¼•å…¥cmrh</span></span><br><span class="line"><span class="comment">// ç”¨äºèµ„æºå¤„ç†</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'asset-require-hook'</span>)(&#123;</span><br><span class="line">  name: <span class="string">'/[hash].[ext]'</span>,</span><br><span class="line">  extensions: [<span class="string">'jpg'</span>, <span class="string">'png'</span>, <span class="string">'gif'</span>],</span><br><span class="line">  limit: <span class="number">8000</span></span><br><span class="line">&#125;)</span><br><span class="line">...</span><br><span class="line">åŒmainjs</span><br><span class="line">...</span><br><span class="line">app.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> send(ctx, ctx.path, &#123; <span class="attr">root</span>: <span class="string">'../dist/client'</span> &#125;) <span class="comment">//æ›´æ”¹é™æ€æ–‡ä»¶ä½ç½®</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>ç‰¹åˆ«éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œä¸¤ä¸ªhookæ¨¡å—éœ€è¦åœ¨<strong>é¡¶éƒ¨å¼•å…¥</strong>ã€‚</p>
<p>ok,è‡³æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å¤„ç†äº†æ ·å¼å’Œå…¶ä»–èµ„æºçš„é—®é¢˜ã€‚jsxå‘¢ï¼Ÿè¿˜è®°å¾—æœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬å®‰è£…çš„<code>babel-cli</code>å—ï¼Ÿå®‰è£…ä¹‹åå°±å¯ä»¥ä½¿ç”¨<code>babel-node</code>äº†ã€‚æ˜¯æ—¶å€™éªŒè¯çƒ¦ççš„é…ç½®ã€‚åœ¨package.jsonçš„scriptsä¸­åŠ å…¥ï¼š<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "dev:client": "webpack-dev-server --hot --config webpack.dev.js",</span><br><span class="line">    "dev:server": "nodemon --exec babel-node ./server/server.dev.js",</span><br><span class="line">    "dev:ssr": "npm run build:client &amp;&amp; npm run dev:server",</span><br><span class="line">    "build:client": "webpack --config webpack.prod.js",</span><br><span class="line">    "build:server": "webpack --config webpack.server.js",</span><br><span class="line">    "build": "npm run build:client &amp;&amp; npm run build:server",</span><br><span class="line">    "test": "jest"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨æ­¤æ·»åŠ äº†ä¸¤ä¸ªå‘½ä»¤:</p>
<p><code>nodemon --exec babel-node ./server/server.dev.js</code></p>
<p><code>npm run build:client &amp;&amp; npm run dev:server</code></p>
<p>è‡³æ­¤å¼€å‘ç¯å¢ƒä¸‹çš„ssrå°±å®Œæˆäº†ã€‚</p>
<p>äº‹å®ä¸Šï¼Œå¾€å¾€æ˜¯åœ¨é¡¹ç›®åæœŸä¹‹åè¿›è¡ŒSSRï¼Œæ‰€ä»¥è™½ç„¶å¯ä»¥è§£å†³devæ—¶é¢‘ç¹çš„buildï¼Œä½†æ˜¯å®é™…æ„ä¹‰å¹¶ä¸å¤§ã€‚</p>
<h4 id="æ‹¥æŠ±React16"><a href="#æ‹¥æŠ±React16" class="headerlink" title="æ‹¥æŠ±React16"></a>æ‹¥æŠ±React16</h4><p><code>ReactDOM.hydrate()</code></p>
<p>åœ¨React 16ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åœ¨å®¢æˆ·ç«¯è¿›è¡Œæ¸²æŸ“ï¼šrenderï¼ˆï¼‰ç”¨äºä½•æ—¶ä»…åœ¨å®¢æˆ·ç«¯å‘ˆç°å†…å®¹ï¼Œè€Œhydrateï¼ˆï¼‰ç”¨äºåœ¨æœåŠ¡å™¨ç«¯å‘ˆç°æ ‡è®°ä¹‹ä¸Šè¿›è¡Œæ¸²æŸ“ï¼Œå¦‚æœåœ¨å·²ç»å…·æœ‰æ­¤æœåŠ¡å™¨å‘ˆç°æ ‡è®°çš„èŠ‚ç‚¹ä¸Šè°ƒç”¨ReactDOM.hydrateï¼ˆï¼‰ï¼Œåˆ™Reactå°†é™„åŠ äº‹ä»¶å¤„ç†ç¨‹åºï¼Œä»è€Œå…·æœ‰é«˜æ€§èƒ½çš„é¦–æ¬¡åŠ è½½ä½“éªŒã€‚<br>ã€‚ React 16é™ä½äº†SSRæ—¶ç”ŸæˆHTMLçš„å¼€é”€ï¼Œ åœ¨React 15ä¸­ï¼ŒSSRæ–‡æ¡£ä¸­çš„æ¯ä¸ªHTMLå…ƒç´ éƒ½æœ‰ä¸€ä¸ªdata-reactidå±æ€§ï¼Œå…¶å€¼ç”±é€’å¢çš„IDç»„æˆï¼Œæ–‡æœ¬èŠ‚ç‚¹è¢«å¸¦æœ‰react-textå’ŒIDçš„æ³¨é‡ŠåŒ…å›´ã€‚ åœ¨React 16ä¸­ï¼Œæ‰€æœ‰IDéƒ½å·²ä»æ ‡è®°ä¸­åˆ é™¤ï¼Œå› æ­¤ç›¸åŒä»£ç æ®µçš„HTMLæ›´åŠ ç²¾ç®€ã€‚</p>
<p>å…³äº <code>ReactDOMServer.renderToNodeStream() ReactDOMServer.renderToStaticNodeStream()</code>å¦‚ä½•è¿”å›ä¸€ä¸ªReadable streamä»è€Œæå‡é¦–å±çš„åŠ è½½é€Ÿåº¦å’Œ<code>renderToStaticMarkup() renderToStaticNodeStream()</code> å¦‚ä½•å»é™¤é¢å¤–çš„DOMå±æ€§æ¥æå‡åŠ è½½é€Ÿåº¦ï¼Œè¯·å‚è€ƒ<a href="https://reactjs.org/docs/react-dom-server.html" target="_blank" rel="noopener">React SSR DOCS</a>ã€‚</p>
<h3 id="æ›´è¿›ä¸€æ­¥-ğŸ¤”"><a href="#æ›´è¿›ä¸€æ­¥-ğŸ¤”" class="headerlink" title="æ›´è¿›ä¸€æ­¥ ğŸ¤”"></a>æ›´è¿›ä¸€æ­¥ ğŸ¤”</h3><ul>
<li>ä¸react-routeré›†æˆæ—¶ï¼š ç”±äºserverç«¯æ²¡æœ‰æµè§ˆå™¨ä¸‹çš„å…¨å±€historyï¼Œéœ€è¦ä½¿ç”¨StaticRouteræ¥æ›¿ä»£ï¼Œå¹¶æä¾›å¿…è¦çš„contextå±æ€§(request.url)ã€‚</li>
<li>readuxé›†æˆæ—¶ï¼Œéœ€è¦åœ¨serverç«¯é…ç½®storeã€‚</li>
<li>æ–‡ä»¶æ‹†åˆ†ï¼Œéšç€é¡¹ç›®å¢å¤§ï¼Œå°†å‰åç«¯å…±äº«çš„è·¯ç”±æ–‡ä»¶æ‹†åˆ†å‡ºæ¥æ˜¯å¿…è¦çš„ã€‚</li>
<li>ä¸styled-componentsé›†æˆæ—¶ï¼Œéœ€è¦ ServerStyleSheetå®ä¾‹ä¸‹çš„collectStyles()å°†ç»„ä»¶æ ·å¼æå–å‡ºæ¥ã€‚é™¤äº†æ»¡è¶³SSRçš„éœ€æ±‚å¤–ï¼Œç”±äºstyled-componentsæ˜¯åœ¨å®¢æˆ·ç«¯è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆæ ·å¼ï¼Œæå‰æå–æ ·å¼åŒæ—¶ä¹Ÿæäº†é«˜å®¢æˆ·ç«¯çš„æ¸²æŸ“é€Ÿåº¦ã€‚</li>
</ul>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="http://domain.com/awesome.mp3">
            </audio>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='2d71ca6b9ce130171bba'
        data-cs='2d8a5c0756c6b9fd1f5ecb9f8faf0ade2c08579b'
        data-r='buctwbzs.github.io'
        data-o='buctwbzs'
        data-a='buctwbzs'
        data-d='true'
    >æŸ¥çœ‹è¯„è®º</div>


    </div>
    
        <div class='side'>
            <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#åŸºç¡€å·¥ä½œ"><span class="toc-number">1.</span> <span class="toc-text">åŸºç¡€å·¥ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ç¯å¢ƒè®¾ç½®"><span class="toc-number">1.1.</span> <span class="toc-text">ç¯å¢ƒè®¾ç½®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#é¡¹ç›®åˆå§‹åŒ–"><span class="toc-number">1.2.</span> <span class="toc-text">é¡¹ç›®åˆå§‹åŒ–</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¼€å§‹å§ï¼-âŒ¨ï¸"><span class="toc-number">2.</span> <span class="toc-text">å¼€å§‹å§ï¼ âŒ¨ï¸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#è¿ˆå‡ºç¬¬ä¸€æ­¥ï¼ğŸ•º"><span class="toc-number">2.1.</span> <span class="toc-text">è¿ˆå‡ºç¬¬ä¸€æ­¥ï¼ğŸ•º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æœ€ç®€å•SSRğŸ¤—"><span class="toc-number">2.2.</span> <span class="toc-text">æœ€ç®€å•SSRğŸ¤—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å®Œæ•´çš„htmlğŸ¤¡"><span class="toc-number">2.3.</span> <span class="toc-text">å®Œæ•´çš„htmlğŸ¤¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ç•Œé¢å¤ªä¸‘äº†-ğŸ˜¤"><span class="toc-number">2.4.</span> <span class="toc-text">ç•Œé¢å¤ªä¸‘äº† ğŸ˜¤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¸åœbuildç´¯skräºº-ğŸ˜"><span class="toc-number">2.5.</span> <span class="toc-text">ä¸åœbuildç´¯skräºº ğŸ˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ‹¥æŠ±React16"><span class="toc-number">2.6.</span> <span class="toc-text">æ‹¥æŠ±React16</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ›´è¿›ä¸€æ­¥-ğŸ¤”"><span class="toc-number">3.</span> <span class="toc-text">æ›´è¿›ä¸€æ­¥ ğŸ¤”</span></a></li></ol>
        </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>